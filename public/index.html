<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    /* 드래그할 때 색상 */
    ::selection {
      background: lightgray; /* 연한 회색 배경 */
    }
  </style>
  <style>
    /* 드래그할 때 색상 */
    ::selection {
      background: lightgray; /* 연한 회색 배경 */
    }
  </style>
</head>
<body>
  <div>

  Lorem ipsum dolor, sit amet consectetur adipisicing elit. Repellat unde aliquid enim nemo mollitia quae veniam similique, inventore qui distinctio maxime explicabo vitae velit modi voluptate, natus voluptatem eveniet itaque?
  Lorem ipsum dolor sit amet consectetur adipisicing elit. Ratione saepe, earum distinctio odio, beatae consectetur vel odit voluptates modi nisi quis est dolor qui dolorem tenetur impedit quo, cumque quas!
  Lorem ipsum dolor sit amet consectetur adipisicing elit. Enim, sequi fuga pariatur, corrupti odio incidunt aut ab odit cumque consequuntur doloribus quasi et at culpa aliquam optio? Molestias, perspiciatis ut.
  </div>
  <button id="deleteAllButton">모두 삭제</button>
  <div id="stored-highlights" style="border: black 1px solid"></div>
  <script>

    drawStoredHighlights();

    document.addEventListener('mouseup', () => {
    const selectedText = window.getSelection();

    // 텍스트를 1글자 이상 긁었을 때 형광펜 효과를 적용하는 로직
    if (selectedText.toString().length > 0) {
      const text = selectedText.toString();
      const start = selectedText.getRangeAt(0).startOffset;
      const end = selectedText.getRangeAt(0).endOffset;

      console.log("selectedText: ", text);
      console.log("startOffset: ", start);
      console.log("endOffset: ", end);

      // 형광펜 효과 적용
      if (!selectedText.isCollapsed) {
      const range = selectedText.getRangeAt(0);
      const span = document.createElement('span');
      span.style.backgroundColor = 'yellow'; // 형광펜 효과
      range.surroundContents(span);

      // 드래그가 끝나고 마우스 버튼을 떼었을 때 드래그 효과를 해제
      selectedText.removeAllRanges();
      }

      // 형광펜 정보 저장
      const highlightInfo = {
        text: text, // 형광펜 칠해진 글자 
        startOffset: start, // 시작 위치
        endOffset: end, // 끝 위치
        // 추가 정보 (예: 페이지 식별자, 위치 등)
      };

      // 형광펜 정보를 백엔드로 전송
      sendHighlightToServer(highlightInfo);
      drawStoredHighlights();
    }
  });

  function sendHighlightToServer(highlightInfo) {
    fetch('/api/save-highlight', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(highlightInfo),
    });
  }

  function deleteOneHighlight(id) {
    console.log("delete one test *** id : ", id);
    fetch('/api/delete-one-highlight', {
       method: 'POST',
       headers: {
         'Content-Type': 'application/json',
       },
       body: JSON.stringify({ id: id }),
      })
      .then(response => {
        if (response.ok) {
          alert('일부 데이터가 삭제되었습니다.');
          drawStoredHighlights();
          // 필요한 경우 여기서 추가적인 UI 업데이트 로직을 수행할 수 있습니다.
        }
      })
      .catch(error => console.error('Error:', error));
  }

  function drawStoredHighlights() {
    
    fetch('/api/find-highlights')
      .then(response => {
        return response.json();
      })
      .then(highlights => {
        const container = document.getElementById('stored-highlights');
        container.innerHTML = '';
        highlights.forEach(highlight => {
          // console.log("*** highlight: ", highlight._id);
          const div = document.createElement('div');
          div.style.border = '1px solid black';
          div.style.padding = '10px';
          div.textContent = "- 저장된 부분: "+highlight.text; // 'text'는 데이터베이스에 저장된 필드
          div.setAttribute('id', highlight._id);
          container.appendChild(div);
          
          //         <button class="deleteOneButton">일부 삭제</button>
          //  findOneHighlight(id);
          const deleteOneButton = document.createElement('button');
          deleteOneButton.textContent = '일부 삭제';
          deleteOneButton.style.margin = '10px';
          deleteOneButton.addEventListener('click', () => {
            deleteOneHighlight(highlight._id);
          });
          div.appendChild(deleteOneButton); 
        });

      })
      .catch(error => console.error('Error:', error));
  }

  function findOneHighlight(id) {
    fetch('/api/find-one-highlight', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ id: id }),
    })
    .then(response => {
      return response.json();
    })
    .then(highlight => {
      console.log('highlight: ', highlight);
    })
    .catch(error => console.error('Error:', error));
  }

  document.getElementById('deleteAllButton').addEventListener('click', function() {
    if (confirm('정말로 모든 데이터를 삭제하시겠습니까?')) {
      fetch('/api/delete-highlights', { method: 'POST' })
        .then(response => {
          if (response.ok) {
            alert('모든 데이터가 삭제되었습니다.');
            drawStoredHighlights();
            // 필요한 경우 여기서 추가적인 UI 업데이트 로직을 수행할 수 있습니다.
          }
        })
        .catch(error => console.error('Error:', error));
    }
  });

  </script>
</body>
</html>